# System Flow Diagram - Bug Fixes Applied

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USER ENTERS PORTAL                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: IDENTIFIER ENTRY                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“± Phone Option           ğŸ“§ Email Option                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚  â”‚  â”‚ Country: DK  â”‚          â”‚ Email Input  â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ Input: Phone â”‚          â”‚              â”‚                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  âœ… FIX #1: Smart Phone Detection                           â”‚ â”‚
â”‚  â”‚  â€¢ Detects +45... (full e164)                              â”‚ â”‚
â”‚  â”‚  â€¢ Detects 45... (has dial code)                           â”‚ â”‚
â”‚  â”‚  â€¢ Detects 42455150 (local only)                           â”‚ â”‚
â”‚  â”‚  â€¢ NO DUPLICATION on paste                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“ Help Text: "Indtast dit mobilnummer eller e-mail..."        â”‚
â”‚     âœ… FIX #5: Visible here, hidden in Step 2                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ [User Clicks "Send kode"]
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API: /identifier/request-otp                   â”‚
â”‚                                                                  â”‚
â”‚  Payload:                                                        â”‚
â”‚  {                                                               â”‚
â”‚    "channel": "phone",                                           â”‚
â”‚    "market": "DFJ_DK",                                           â”‚
â”‚    "phone": "+4542455150",     â† âœ… FIX #1: No duplication      â”‚
â”‚    "phoneDigits": "4542455150",                                  â”‚
â”‚    "country": "DK"                                               â”‚
â”‚  }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LAMBDA: request-otp Handler                   â”‚
â”‚                                                                  â”‚
â”‚  1. Check if identifier exists in Salesforce                     â”‚
â”‚     â””â”€ Query Shared_Document__c by email/phone                   â”‚
â”‚                                                                  â”‚
â”‚  2. âœ… FIX #2: ALWAYS Create OTP__c Record                       â”‚
â”‚     (Even if no match found)                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚     â”‚ OTP__c Fields:                      â”‚                     â”‚
â”‚     â”‚ â€¢ Purpose__c = "DocumentPortal"     â”‚                     â”‚
â”‚     â”‚ â€¢ Identifier_Type__c = "Phone"      â”‚                     â”‚
â”‚     â”‚ â€¢ Identifier_Value__c = "+4542..."  â”‚                     â”‚
â”‚     â”‚ â€¢ Code__c = "123456"                â”‚                     â”‚
â”‚     â”‚ â€¢ Status__c = "Pending"             â”‚                     â”‚
â”‚     â”‚ â€¢ Expires_At__c = now + 5 min       â”‚                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                  â”‚
â”‚  3. Return {"ok": true} (always, no enumeration)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 2: VERIFY OTP CODE                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                          [Start forfra] â† âœ…â”‚ â”‚
â”‚  â”‚                                          FIX #6: Top-right  â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚              Enter 6-digit code: [______]                    â”‚ â”‚
â”‚  â”‚                     [Verify Button]                          â”‚ â”‚
â”‚  â”‚                                                              â”‚ â”‚
â”‚  â”‚  âœ… FIX #5: Help text HIDDEN                                â”‚ â”‚
â”‚  â”‚  âœ… FIX #5: Phone/Email chooser HIDDEN                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ [User Enters OTP]
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API: /identifier/verify-otp                    â”‚
â”‚                                                                  â”‚
â”‚  â€¢ Find OTP__c by Purpose + Brand + Identifier                   â”‚
â”‚  â€¢ Verify code matches Code__c                                   â”‚
â”‚  â€¢ Check Expires_At__c > now                                     â”‚
â”‚  â€¢ Update Status__c = "Verified"                                 â”‚
â”‚  â€¢ Return session token                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ âœ… Success
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PORTAL UI: Document List                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Sidebar   â”‚ Viewer                                         â”‚ â”‚
â”‚  â”‚           â”‚                                                â”‚ â”‚
â”‚  â”‚ Pending:  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚ â€¢ Doc 1   â”‚  â”‚                                          â”‚ â”‚ â”‚
â”‚  â”‚ â€¢ Doc 2   â”‚  â”‚      PDF VIEWER (inline)                 â”‚ â”‚ â”‚
â”‚  â”‚           â”‚  â”‚      âœ… FIX #3: No auto-download         â”‚ â”‚ â”‚
â”‚  â”‚ Approved: â”‚  â”‚      âœ… FIX #4: Visible iframe           â”‚ â”‚ â”‚
â”‚  â”‚ â€¢ Doc 3   â”‚  â”‚                                          â”‚ â”‚ â”‚
â”‚  â”‚           â”‚  â”‚                                          â”‚ â”‚ â”‚
â”‚  â”‚ [FAQ]     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚ [Help]    â”‚                                                â”‚ â”‚
â”‚  â”‚           â”‚  [Download] [Print] [Approve]                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ [User Clicks Document]
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   API: /identifier/doc-url                       â”‚
â”‚                                                                  â”‚
â”‚  â€¢ Verify session token                                          â”‚
â”‚  â€¢ Check document ownership                                      â”‚
â”‚  â€¢ Generate S3 presigned URL                                     â”‚
â”‚                                                                  â”‚
â”‚  âœ… FIX #3: S3 Presign Parameters                               â”‚
â”‚  {                                                               â”‚
â”‚    "ResponseContentDisposition": "inline; filename=doc.pdf",     â”‚
â”‚    "ResponseContentType": "application/pdf"                      â”‚
â”‚  }                                                               â”‚
â”‚                                                                  â”‚
â”‚  â€¢ Update Last_Viewed__c                                         â”‚
â”‚  â€¢ Change Status__c: "Sent" â†’ "Viewed"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PDF RENDERS IN IFRAME                         â”‚
â”‚                                                                  â”‚
â”‚  <iframe id="pdf" src="https://s3.../doc.pdf?                    â”‚
â”‚    response-content-disposition=inline&                          â”‚
â”‚    response-content-type=application/pdf#toolbar=0&zoom=150">   â”‚
â”‚                                                                  â”‚
â”‚  âœ… FIX #3: Displays inline, NO auto-download                    â”‚
â”‚  âœ… FIX #4: Visible and functional                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Fix Impact Summary

### ğŸ”§ Fix #1: Phone Normalization
**Impact:** Frontend (app.js)  
**Result:** Users can paste full international numbers without duplication

### ğŸ”§ Fix #2: Always Create OTP
**Impact:** Backend (lambda.py)  
**Result:** OTP records created even for non-existent identifiers (anti-enumeration maintained)

### ğŸ”§ Fix #3: Inline PDFs
**Impact:** Backend (lambda.py)  
**Result:** PDFs render inline instead of forcing download

### ğŸ”§ Fix #4: Viewer Visibility
**Impact:** None (already working correctly)  
**Result:** Confirmed viewer displays properly

### ğŸ”§ Fix #5: Hide Help Text
**Impact:** Frontend (app.js)  
**Result:** Cleaner UX during OTP verification step

### ğŸ”§ Fix #6: Button Position
**Impact:** Frontend (styles.css)  
**Result:** "Start forfra" button in intuitive top-right position

---

## Data Flow: Phone Input Example

```
User Input:        "+4542455150"
                        â†“
Detection:         Starts with '+' â†’ already e164
                        â†“
Normalization:     mcNormDK("+4542455150")
                        â†“
Extract digits:    "4542455150"
                        â†“
Double-check:      Starts with "4545"? No â†’ OK
                        â†“
Validate:          Starts with "45" âœ“
                   Length = 10 âœ“
                        â†“
Result:            {
                     digits: "4542455150",
                     ok: true,
                     e164: "+4542455150"
                   }
                        â†“
API Payload:       {
                     "phone": "+4542455150",
                     "phoneDigits": "4542455150"
                   }
```

### Edge Case: Double Prefix

```
User Input:        "4545421234" (accidentally doubled)
                        â†“
Extract digits:    "4545421234"
                        â†“
Double-check:      Starts with "4545" AND length â‰¥ 12? Yes
                        â†“
Fix:               Remove first 2 chars â†’ "4542455150"
                        â†“
Validate:          Starts with "45" âœ“
                   Length = 10 âœ“
                        â†“
Result:            {
                     digits: "4542455150",
                     ok: true,
                     e164: "+4542455150"
                   }
```

---

## Salesforce Object Updates

### OTP__c Record (Fix #2)
```
Before: Created only if identifier matches
After:  ALWAYS created (match or no match)

Record Example:
{
  Id: "a0X5g000000AbCd",
  Key__c: "DocumentPortal|Phone|+4542455150|dk|abc123",
  Purpose__c: "DocumentPortal",
  Brand__c: "dk",
  Identifier_Type__c: "Phone",
  Identifier_Value__c: "+4542455150",
  Channel__c: "SMS",
  Code__c: "123456",
  Status__c: "Pending",
  Sent_At__c: "2025-10-17T10:30:00Z",
  Expires_At__c: "2025-10-17T10:35:00Z",
  Attempt_Count__c: 0,
  Resend_Count__c: 0
}
```

### Shared_Document__c Updates (Existing)
```
On View:
  Last_Viewed__c = NOW()
  Status__c = "Sent" â†’ "Viewed"

On Approve:
  Status__c = "Viewed" â†’ "Approved"
```

---

**Diagram Version:** 1.0  
**Last Updated:** October 17, 2025  
**Coverage:** All 6 bug fixes visualized
